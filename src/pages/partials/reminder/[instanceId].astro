---
import { db, Reminder, eq } from "astro:db";
const instanceId = Astro.params.instanceId;

const ACCESS_KEY = import.meta.env.ACCESS_KEY;
const ORCHESTRATOR_TERMINATE_URL = import.meta.env.ORCHESTRATOR_TERMINATE_URL;

try {
  const res = await fetch(
    `${ORCHESTRATOR_TERMINATE_URL}${instanceId}/terminate?taskHub=TestHubName&connection=Storage&code=${ACCESS_KEY}`,
    {
      method: "POST",
    }
  );

  if (!res.ok) {
    throw new Error("Failed to terminate instance");
  }

  await db.delete(Reminder).where(eq(Reminder.orchestrationId, instanceId));

  return new Response(null, { status: 200 });
} catch (error) {
  console.error(error);
  return;
}
---
